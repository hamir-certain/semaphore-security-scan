version: v1.0
name: Semaphore Security Scan Pipeline
agent:
  machine:
    type: s1-kubernetes

blocks:
  - name: "Extract Images from Helm Chart"
    task:
      jobs:
        - name: Extract Image List
          commands:
            - checkout
            - echo "Downloading Semaphore Helm chart v1.5.0..."
            - curl -L https://github.com/semaphoreio/semaphore/releases/download/v1.5.0/semaphore-v1.5.0.tgz -o semaphore-v1.5.0.tgz
            - tar -xzf semaphore-v1.5.0.tgz
            - echo "Extracting images from values.yaml..."
            - python3 scripts/extract-images.py semaphore/values.yaml > images-list.txt
            - echo "Images extracted successfully"
            - cat images-list.txt
            - artifact push workflow images-list.txt

  - name: "Trivy Security Scan"
    task:
      prologue:
        commands:
          - checkout
          - artifact pull workflow images-list.txt
      jobs:
        - name: Scan Image
          matrix:
            - env_var: IMAGE
              values:
                # Application Images
                - "ghcr.io/semaphoreio/artifacthub:529ed00cf85b6c99fda207cbbcd774f00592fcca"
                - "ghcr.io/semaphoreio/audit:bd10abf1870c8247bb7b12e922aa865863255066"
                - "ghcr.io/semaphoreio/auth:570873cccc0c443e433697a0efb7a3f33d6f3ecd"
                - "ghcr.io/semaphoreio/badges:ca99da955f57364a0742800c4be606f7273dd5b0"
                - "ghcr.io/semaphoreio/bootstrapper:3dc98d61830f896779dcbc8ac351937a767246a9"
                - "ghcr.io/semaphoreio/branch_hub:f91642321656d85f76624f30dc65df04748d9a8a"
                - "ghcr.io/semaphoreio/dashboardhub:bd10abf1870c8247bb7b12e922aa865863255066"
                - "ghcr.io/semaphoreio/encryptor:7cb53760f53f6b93ce3a5c86ac418edbccb83e84"
                - "ghcr.io/semaphoreio/front:c4bdd9c00662df0ccc0f0a5731d81e39b96ea844"
                - "ghcr.io/semaphoreio/github-notifier:ca99da955f57364a0742800c4be606f7273dd5b0"
                - "ghcr.io/semaphoreio/github_hooks:d54f88485a8ee0b078e70bd39d2ce6b43eeb5c0c"
                - "ghcr.io/semaphoreio/gofer:ca99da955f57364a0742800c4be606f7273dd5b0"
                - "ghcr.io/semaphoreio/guard:71d97737dcd4c147dd48d8971b14a2e0f4b92710"
                - "ghcr.io/semaphoreio/hooks-processor:f3a59a99f766e3424e2ace4af72a51ac0b7d4a0e"
                - "ghcr.io/semaphoreio/hooks-receiver:ca99da955f57364a0742800c4be606f7273dd5b0"
                - "ghcr.io/semaphoreio/keycloak-setup:09c3479c1ed0268e616eb1f6efc5560a46901f8c"
                - "ghcr.io/semaphoreio/keycloak:9d8d8a9fa94b10aa6aae92ce37dfb8b84b2806aa"
                - "ghcr.io/semaphoreio/loghub2:f6988855dea477d94a6ab3d00f93e710c54625b2"
                - "ghcr.io/semaphoreio/notifications:af028026dce8936799662ef3f99458df5fd6c49b"
                - "ghcr.io/semaphoreio/periodic-scheduler:9480e60fb47ca8d7caf3cfd7ddcdaa0f5ffd2ced"
                - "ghcr.io/semaphoreio/plumber-public:fc0ba626a18ff304660395e1657bb6fb69fbcd96"
                - "ghcr.io/semaphoreio/plumber:e702c50ca730258eca7980f9879f3e1b2c558957"
                - "ghcr.io/semaphoreio/pre-flight-checks-hub:3facc2c7dd33174f5e50010d3d34820c5bb354b8"
                - "ghcr.io/semaphoreio/projecthub-public:9480e60fb47ca8d7caf3cfd7ddcdaa0f5ffd2ced"
                - "ghcr.io/semaphoreio/projecthub:9480e60fb47ca8d7caf3cfd7ddcdaa0f5ffd2ced"
                - "ghcr.io/semaphoreio/public-api-gateway:b56bb174d0122b324472379efaf297b69880778a"
                - "ghcr.io/semaphoreio/public-api:9480e60fb47ca8d7caf3cfd7ddcdaa0f5ffd2ced"
                - "ghcr.io/semaphoreio/rbac:e805920f02975cccc27aca9b7e74a4df0f23b685"
                - "ghcr.io/semaphoreio/rbac_ee:65fe8a59cfdae6e775ba503f298c3a9379a1e976"
                - "ghcr.io/semaphoreio/repohub:7cb53760f53f6b93ce3a5c86ac418edbccb83e84"
                - "ghcr.io/semaphoreio/repository_hub:7e108a16c449af177c925b1c8fab9581f8b5315c"
                - "ghcr.io/semaphoreio/scouter:3facc2c7dd33174f5e50010d3d34820c5bb354b8"
                - "ghcr.io/semaphoreio/secrethub:ca99da955f57364a0742800c4be606f7273dd5b0"
                - "ghcr.io/semaphoreio/self-hosted-hub:377ba70acb65ef3f62559fe828482adcc60a4b3d"
                - "ghcr.io/semaphoreio/statsd:3facc2c7dd33174f5e50010d3d34820c5bb354b8"
                - "ghcr.io/semaphoreio/velocity-hub:ca99da955f57364a0742800c4be606f7273dd5b0"
                - "ghcr.io/semaphoreio/zebra:f4f1d3a7d3567b091deaf0137eb4dd8e365646dc"
                # Infrastructure Images
                - "postgres:14.15-alpine3.21"
                - "rabbitmq:3.13.7-management-alpine"
                - "redis:7.2.4-alpine3.19"
                - "minio/minio:RELEASE.2021-04-22T15-44-28Z.hotfix.56647434e"
                - "postgres:13"
                - "curlimages/curl:latest"
                - "docker.io/erlang:26"
          commands:
            # Install Trivy
            - echo "Installing Trivy..."
            - wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
            - echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
            - sudo apt-get update
            - sudo apt-get install -y trivy

            # Verify Trivy installation
            - trivy --version

            # Create output directory
            - mkdir -p scan-results

            # Sanitize image name for filename (replace / and : with _)
            - export SAFE_IMAGE_NAME=$(echo "$IMAGE" | sed 's|/|_|g' | sed 's|:|_|g')
            - echo "Scanning image $IMAGE..."
            - echo "Results will be saved as $SAFE_IMAGE_NAME"

            # Run Trivy scan and generate markdown report
            # - Scan for vulnerabilities in OS packages and application dependencies
            # - Output in markdown format for easy aggregation
            - trivy image --severity HIGH,CRITICAL --format json --output "scan-results/${SAFE_IMAGE_NAME}.json" "$IMAGE"

            # Generate markdown report from JSON
            - |
              cat > "scan-results/${SAFE_IMAGE_NAME}.md" << MARKDOWN_EOF
              ## Image: \`$IMAGE\`

              **Scan Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")

              ### Vulnerabilities Summary

              MARKDOWN_EOF

            # Add vulnerability table
            - trivy image --severity HIGH,CRITICAL --format table "$IMAGE" >> "scan-results/${SAFE_IMAGE_NAME}.md"

            # Display summary
            - echo "Scan complete for $IMAGE"
            - cat "scan-results/${SAFE_IMAGE_NAME}.md"

            # Upload markdown report as artifact
            - artifact push job scan-results/${SAFE_IMAGE_NAME}.md

  - name: "Generate Security Report"
    task:
      jobs:
        - name: Aggregate Results
          commands:
            - checkout
            - mkdir -p all-scan-results
            - echo "Pulling all markdown reports from previous jobs..."
            - artifact pull workflow all-scan-results --destination all-scan-results || true
            - echo "Creating aggregated REPORT.md..."
            - |
              cat > REPORT.md << 'HEADER_EOF'
              # Semaphore Security Scan Report

              **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
              **Helm Chart Version:** v1.5.0
              **Total Images Scanned:** 43

              ---

              HEADER_EOF
            - |
              # Append all individual markdown reports
              for md_file in all-scan-results/*.md; do
                if [ -f "$md_file" ]; then
                  cat "$md_file" >> REPORT.md
                  echo "" >> REPORT.md
                  echo "---" >> REPORT.md
                  echo "" >> REPORT.md
                fi
              done
            - |
              # Add summary footer
              cat >> REPORT.md << 'FOOTER_EOF'

              ## Recommendations

              1. **Critical Vulnerabilities**: Prioritize images with CRITICAL vulnerabilities for immediate remediation
              2. **High Vulnerabilities**: Schedule updates for images with HIGH vulnerabilities
              3. **Regular Scans**: Run this pipeline regularly (e.g., weekly) to catch new vulnerabilities
              4. **Image Updates**: Consider updating base images and dependencies
              5. **Vulnerability Database**: Ensure Trivy vulnerability database is up to date

              ## Next Steps

              - Review individual image sections above for detailed vulnerability information
              - Create tickets for images requiring updates
              - Monitor CVE feeds for newly disclosed vulnerabilities
              - Consider implementing automated image rebuilds when vulnerabilities are patched

              FOOTER_EOF
            - echo "REPORT.md generated successfully"
            - echo "First 100 lines of REPORT.md:"
            - head -100 REPORT.md
            - artifact push workflow REPORT.md
